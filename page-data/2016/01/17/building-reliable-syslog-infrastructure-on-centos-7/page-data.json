{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2016/01/17/building-reliable-syslog-infrastructure-on-centos-7/",
    "result": {"data":{"site":{"siteMetadata":{"title":"RFaircloth Data Nerd"}},"markdownRemark":{"id":"25cf158f-9f1b-5c2e-96c2-00171d533dbd","excerpt":"Overview Preparation of a base infrastructure for high availability ingestion of syslog data with a default virtual server and configuration for test data on…","html":"<h2>Overview</h2>\n<p>Preparation of a base infrastructure for high availability ingestion of syslog data with a default virtual server and configuration for test data on boarding. Reference technology specific on boarding procedures.</p>\n<h2>Requirement</h2>\n<p>Multiple critical log sources require a reliable syslog infrastructure. The following attributes must be present for the solution</p>\n<ul>\n<li>Enterprise supported linux such as RHEL, OR Centos</li>\n<li>Syslog configuration which will not impact the logging of the host on which syslog is configured</li>\n<li>External Load Balancing utilizing DNAT lacking available enterprise shared services NLB devices KEMP offers a free to use version of their product up to 20 Mbs suitable for many cases</li>\n</ul>\n<h2>Technical Environment</h2>\n<p>The following systems will be created utilizing physical or virtual systems. System specifications will vary due estimated load.</p>\n<ul>\n<li>Centos 7.x (current) servers in n+1 configuration\n<ul>\n<li>Minimum 2 GB memory</li>\n<li>Minimum 2 x 2.3 GHZ core</li>\n<li>Mounts configure per enterprise standard with the following additions\n<ul>\n<li>/opt/splunk 40 GB XFS</li>\n<li>/var/splunk-syslog 40 GB XFS</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Dual interfaced load balancer configured for DNAT support.</li>\n<li>Subnet with at minimum the number of unique syslog sources (technologies) additional space for growth is strongly advised</li>\n<li>Subnet allocated for syslog servers</li>\n</ul>\n<h2>Solution Prepare the syslog-ng servers</h2>\n<p>The following procedure will be utilized to prepare the syslog-ng servers</p>\n<ol>\n<li>Install the base operating system and harden according to enterprise standards</li>\n<li>Provision and mount the application partitions /opt/splunk and /var/splunk-syslog according the estimates required for your environment.</li>\n<li>Note 1 typical configuration utilize noatime on both mounts</li>\n<li>Note 2 typical configuration utilizes no execute on the syslog moun</li>\n<li>Enable the EPEL repository for RHEL/CENTOS as the source for syslog-ng installation</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">  yum -y <span class=\"token function\">install</span> epel-release\n  yum -y repolist\n  yum -y update\n  <span class=\"token function\">reboot</span></code></pre></div>\n<ol start=\"4\">\n<li>Install the syslog-ng software</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">  yum y <span class=\"token function\">install</span> syslog-ng</code></pre></div>\n<ol start=\"5\">\n<li>Replace /etc/syslog-ng/syslog-ng.conf</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  @version:3.5\n  @include \"scl.conf\"\n\n# syslog-ng configuration file\n\n#\n\n# SecKit template\n\n# We utilize syslog-ng on Centos to allow syslog ingestion without\n\n# interaction with the OS\n\n# Note: it also sources additional configuration files (*.conf)\n\n# located in /etc/syslog-ng/conf.d/\n\n  options {\n      flush_lines (0);\n      time_reopen (10);\n      log_fifo_size (1000);\n      chain_hostnames (off);\n      use_dns (no);\n      use_fqdn (no);\n      create_dirs (no);\n      keep_hostname (yes);\n  };\n\n# Source additional configuration files (.conf extension only)\n\n  @include \"/etc/syslog-ng/conf.d/*.conf\"\n</code></pre></div>\n<ol start=\"6\">\n<li>Create the following directories for modular configuration of syslog-ng</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">  <span class=\"token function\">mkdir</span> -p /etc/syslog-ng/conf.d/splunk-0-source\n  <span class=\"token function\">mkdir</span> -p /etc/syslog-ng/conf.d/splunk-1-dest\n  <span class=\"token function\">mkdir</span> -p /etc/syslog-ng/conf.d/splunk-2-filter\n  <span class=\"token function\">mkdir</span> -p /etc/syslog-ng/conf.d/splunk-3-log\n  <span class=\"token function\">mkdir</span> -p /etc/syslog-ng/conf.d/splunk-4-simple</code></pre></div>\n<ol start=\"7\">\n<li>Create the Splunk master syslog-configuration /etc/syslog-ng/conf.d/splunk.conf</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">  <span class=\"token comment\">################################################################################</span>\n  <span class=\"token comment\"># SecKit syslog template based on the work of Vladimir</span>\n  <span class=\"token comment\"># Template from https://github.com/hire-vladimir/SA-syslog_collection/</span>\n  <span class=\"token comment\">################################################################################</span>\n\n  <span class=\"token comment\">################################################################################</span>\n  <span class=\"token comment\">#### Global config ####</span>\n  options <span class=\"token punctuation\">{</span>\n    create-dirs<span class=\"token punctuation\">(</span>yes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\"># Specific file/directory permissions can be set</span>\n    <span class=\"token comment\"># this is particularly needed, if Splunk UF is running as non-root</span>\n    owner<span class=\"token punctuation\">(</span><span class=\"token string\">\"splunk\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    group<span class=\"token punctuation\">(</span><span class=\"token string\">\"splunk\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    dir-owner<span class=\"token punctuation\">(</span><span class=\"token string\">\"splunk\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    dir-group<span class=\"token punctuation\">(</span><span class=\"token string\">\"splunk\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    dir-perm<span class=\"token punctuation\">(</span>0755<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    perm<span class=\"token punctuation\">(</span>0755<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    time-reopen<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    keep-hostname<span class=\"token punctuation\">(</span>yes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    log-msg-size<span class=\"token punctuation\">(</span><span class=\"token number\">65536</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  @include <span class=\"token string\">\"/etc/syslog-ng/conf.d/splunk-0-source/*.conf\"</span>\n  @include <span class=\"token string\">\"/etc/syslog-ng/conf.d/splunk-1-dest/*.conf\"</span>\n  @include <span class=\"token string\">\"/etc/syslog-ng/conf.d/splunk-2-filter/*.conf\"</span>\n  @include <span class=\"token string\">\"/etc/syslog-ng/conf.d/splunk-3-log/*.conf\"</span>\n  @include <span class=\"token string\">\"/etc/syslog-ng/conf.d/splunk-4-simple/*.conf\"</span></code></pre></div>\n<ol start=\"8\">\n<li>Create the catch all syslog collection source. /etc/syslog-ng/conf.d/splunk-4-simple/8100-default.conf</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  ################################################################################\n  #### Enable listeners ####\n  source remote8100_default\n  {\n      udp(port(8100));\n      tcp(port(8100));\n  };\n\n#### Log remote sources classification ####\n\n  destination d_default_syslog {\n          file(\"/var/splunk-syslog/default/$HOST.log\");\n  };\n\n# catch all, all data that did not meet above criteria will end up here\n\n  log {\n          source(remote8100_default);\n          destination(d_default_syslog);\n          flags(fallback);\n  };\n</code></pre></div>\n<ol start=\"9\">\n<li>Ensure splunk can read from the syslog folders. The paths should exist at this point due to the dedicated mount</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">  <span class=\"token function\">chown</span> -R splunk:splunk /var/splunk-syslog\n  <span class=\"token function\">chmod</span> -R 0755 /var/splunk-syslog</code></pre></div>\n<ol start=\"10\">\n<li>Verify syslog-ng configuration no errors should be reported (no output)</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">  syslog-ng -s</code></pre></div>\n<ol start=\"11\">\n<li>Update the systemd servics configuration to correctly support both rsyslog and syslog-ng edit /lib/systemd/system/syslog-ng.service</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">  find:\n  <span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/sbin/syslog-ng -F -p /var/run/syslogd.pid\n  replace:\n  <span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/sbin/syslog-ng -F -p /var/run/syslogd-ng.pid</code></pre></div>\n<ol start=\"12\">\n<li>Create log rotation configuration /etc/logrotate.d/splunk-syslog</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  /var/splunk-syslog/*/*.log\n  {\n      daily\n      compress\n      delaycompress\n      rotate 4\n      ifempty\n      maxage 7\n      nocreate\n      missingok\n      sharedscripts\n      postrotate\n      /bin/kill -HUP `cat /var/run/syslogd-ng.pid 2> /dev/null` 2> /dev/null || true\n      endscript\n  }</code></pre></div>\n<ol start=\"13\">\n<li>Resolve SELinux blocked actions</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">  semanage port -a -t syslogd_port_t -p tcp <span class=\"token number\">8100</span>\n  semanage port -a -t syslogd_port_t -p udp <span class=\"token number\">8100</span>\n  semanage fcontext -a -t var_log_t /var/splunk-syslog\n  restorecon -v <span class=\"token string\">'/var/splunk-syslog'</span>\n  logger -d -P <span class=\"token number\">8100</span> -n <span class=\"token number\">127.0</span>.0.1 -p <span class=\"token number\">1</span> <span class=\"token string\">\"test2\"</span>\n  <span class=\"token builtin class-name\">cd</span> /root\n  <span class=\"token function\">mkdir</span> selinux\n  <span class=\"token builtin class-name\">cd</span> selinux\n  audit2allow -M syslog-ng-modified -l -i /var/log/audit/audit.log\n  <span class=\"token comment\">#verify the file does not contain anything no related to syslog</span>\n  <span class=\"token function\">vim</span> syslog-ng-modified.te\n  semodule -i syslog-ng-modified.pp</code></pre></div>\n<ol start=\"14\">\n<li>Allow firewall access to the new ports</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">  firewall-cmd --permanent --zone<span class=\"token operator\">=</span>public --add-port<span class=\"token operator\">=</span><span class=\"token number\">8100</span>/tcp\n  firewall-cmd --permanent --zone<span class=\"token operator\">=</span>public --add-port<span class=\"token operator\">=</span><span class=\"token number\">8100</span>/udp\n  firewall-cmd --reload</code></pre></div>\n<ol start=\"15\">\n<li>Enable and start syslog-ng</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">  systemctl <span class=\"token builtin class-name\">enable</span> syslog-ng\n  systemctl start syslog-ng</code></pre></div>\n<h2>Solution Prepare KEMP Loadbalancer</h2>\n<ul>\n<li>Deploy virtual load balancer to hypervisor with two virtual interfaces\n<ul>\n<li>#1 Enterprise LAN</li>\n<li>#2 Private network for front end of syslog servers</li>\n</ul>\n</li>\n<li>Login to the load balancer web UI</li>\n<li>Apply free or purchased license</li>\n<li>Navigate to network setup\n<ul>\n<li>Set eth0 external ip</li>\n<li>Set eth1 internal ip</li>\n</ul>\n</li>\n<li>Add the first virtual server (udp)\n<ul>\n<li>Navigate to Virtual Services –> Add New</li>\n<li>set the virtual address</li>\n<li>set port 514</li>\n<li>set port name syslog-default-8100-udp</li>\n<li>set protocol udp</li>\n<li>Click Add this virtual service</li>\n<li>Adjust virtual service settings\n<ul>\n<li>Force Layer 7</li>\n<li>Transparency</li>\n<li>set persistence mode source ip</li>\n<li>set persistence time 6 min</li>\n<li>set scheduling method lest connected</li>\n<li>Use Server Address for NAT</li>\n<li>Click Add new real server - Enter IP of syslog server 1 - Enter port 8100</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Add the first virtual server (tcp)\n<ul>\n<li>Navigate to Virtual Services –> Add New</li>\n<li>set the virtual address</li>\n<li>set port 514</li>\n<li>set port name syslog-default-8100-tcp</li>\n<li>set protocol tcp</li>\n<li>Click Add this virtual service</li>\n<li>Adjust virtual service settings\n<ul>\n<li>Service type Log Insight</li>\n<li>Transparency</li>\n<li>set scheduling method lest connected</li>\n<li>TCP Connection only check port 8100</li>\n<li>Click Add new real server - Enter IP of syslog server 1 - Enter port 8100</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Repeat the add virtual server process for additional resource servers</li>\n</ul>\n<h2>Update syslog server routing configuration</h2>\n<p>Update the default gateway of the syslog servers to utilize the NLB internal interface</p>\n<h2>Validation procedure</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">#from a linux host utilize the following commands to validate the NLB and log servers are working together\nlogger -P 514 -T -n &lt;vip_ip> \"test TCP\"\nlogger -P 514 -d -n &lt;vip_ip> \"test UDP\"\nverify the messages are logged in /var/splunk-syslog/default</code></pre></div>\n<h2>Prepare Splunk Infrastructure for syslog</h2>\n<ul>\n<li>Follow procedure for deployment of the Universal Forwarder with deployment client ensure the client has has valid outputs and base configuration</li>\n<li>Create the indexes syslog and syslog_unclassified</li>\n<li>Deploy input configuration for the default input</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[monitor:///var/splunk-syslog/default/*.log]\nhost_regex = .*\\/(.*)\\.log\nsourcetype = syslog\nsource = syslog_enterprise_default\nindex = syslog_unclassified\ndisabled = enabled</code></pre></div>\n<ul>\n<li>Validate the index contains data</li>\n</ul>","frontmatter":{"title":"Building Reliable Syslog infrastructure on Centos 7 for Splunk","date":"January 18, 2016","description":null}},"previous":{"fields":{"slug":"/2016/01/16/when-you-have-100-problems-more-logs-are-not-the-answer/"},"frontmatter":{"title":"When you have 100 problems, more logs are not the answer"}},"next":{"fields":{"slug":"/2016/02/17/dealing-with-bad-threat-data/"},"frontmatter":{"title":"Dealing with bad threat data"}}},"pageContext":{"id":"25cf158f-9f1b-5c2e-96c2-00171d533dbd","previousPostId":"99ae12b0-0b26-5a59-9949-7771dcfaaa5e","nextPostId":"bb0dfc20-b7ac-5610-a6be-fcab20078c6f"}},
    "staticQueryHashes": ["2841359383","3257411868"]}